Pretty slow for just 2000 lines, but it works!

Extensive explanation of hacky pipelines in the comments.
